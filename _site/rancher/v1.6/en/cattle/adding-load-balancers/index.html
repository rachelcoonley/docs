<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Load Balancers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Documentation for Rancher">
    <link href="/docs/favicon.png" rel="shortcut icon" type="image/png" sizes="16x16">
    <link href="/docs/css/syntax.css?t=2017-09-13 18:12:52 -0700" rel="stylesheet">
    <link href="/docs/vendor/font-awesome/css/font-awesome.min.css?t=2017-09-13 18:12:52 -0700" rel="stylesheet">
    <link href="/docs/vendor/lato/lato.css?t=2017-09-13 18:12:52 -0700" rel="stylesheet">
    <link href="/docs/css/lacsso.css?t=2017-09-13 18:12:52 -0700" rel="stylesheet">
    <link href="/docs/css/slicknav.css?t=2017-09-13 18:12:52 -0700" rel="stylesheet">
    <link href="/docs/css/rancher-docs.css?t=2017-09-13 18:12:52 -0700" rel="stylesheet">
  </head>
  <body class="bg-default">
    <div class="row body">
      <header id="header" class="section">
        <nav class="row" role="navigation">
          <div class="col span-3">
          <a class="navbar-brand" href="/"><img src="/docs/img/rancher-logo-nopadding.svg" width="200px" style="padding-left: 20px" /></a>
          </div>

          <div class="col span-5 offset-3">
            <!--Start Google Search-->
            <div class="gcse-search" id="google-search"></div>
            <script>
              var match = window.location.pathname.match(/\/rancher\/([^\/]+)/);
              if ( match ) {
                document.getElementById('google-search').setAttribute('data-defaultToRefinement', match[1]);
              }

              (function() {
                var cx = '007896692384436596364:60akf3bfmxm';
                var gcse = document.createElement('script');
                gcse.type = 'text/javascript';
                gcse.async = true;
                gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(gcse, s);
              })();
            </script>
            <!--End Google Search-->
          </div>
        </nav>
      </header>
      <div class="col span-3 mt-0 mr-0 sidebar">

<ul id="menu">
    <li><a href="/docs/rancher/v1.6/en/">Overview</a></li>
    <li><a href="/docs/rancher/v1.6/en/quick-start-guide/">Quick Start Guide</a></li>
    <li>
        <a href="#">Installing Rancher<i class="pull-right fa fa-angle-down"></i></a>
        <ul>
          <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/">Rancher Server</a></li>
          <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/#requirements">Rancher Server Requirements</a></li>
          <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/#rancher-server-tags">Rancher Server Tags</a></li>
          <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/#single-container">Launching Rancher Server</a></li>
          <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/#multi-nodes">Setting up HA</a></li>
          <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/#requirements-for-ha">HA Requirements</a></li>
          <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/#single-container-external-database">Using an External DB</a></li>
          <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/#single-container-bind-mount">Bind Mounted MySQL Volume</a></li>
          <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/#elb">Using an ELB in AWS</a></li>
          <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/#ldap">Using LDAP/AD with TLS</a></li>
          <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/#http-proxy">Behind an HTTP Proxy</a></li>
          <li><a href="/docs/rancher/v1.6/en/installing-rancher/selinux/">SELinux Requirements for RHEL/CentOS</a></li>
          <li>
               <a href="#">Basic SSL Configuration<i class="pull-right fa fa-angle-down"></i></a>
               <ul>
                 <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/basic-ssl-config/#requirements">Requirements</a></li>
                 <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/basic-ssl-config/#example-nginx-configuration">Example NGINX Configuration</a></li>
                 <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/basic-ssl-config/#example-apache-configuration">Example Apache Configuration</a></li>
                 <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/basic-ssl-config/#example-haproxy-configuration">Example HAProxy Configuration</a></li>
                 <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/basic-ssl-config/#example-f5-big-ip-configuration">Example F5 BIG-IP Configuration</a></li>
                 <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/basic-ssl-config/#elb">Using an ELB in AWS with SSL</a></li>
                 <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/basic-ssl-config/#using-self-signed-certs-beta">Using Self Signed Certs</a></li>
               </ul>
          </li>
          <li>
               <a href="#">No Internet Access<i class="pull-right fa fa-angle-down"></i></a>
               <ul>
                 <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/no-internet-access/#using-a-private-registry">Using a Private Registry</a></li>
                 <li><a href="/docs/rancher/v1.6/en/installing-rancher/installing-server/no-internet-access/#using-an-http-proxy">Using an HTTP Proxy</a></li>
               </ul>
          </li>
        </ul>
    </li>
    <li>
         <a href="#">Upgrading Rancher<i class="pull-right fa fa-angle-down"></i></a>
         <ul>
           <li><a href="/docs/rancher/v1.6/en/upgrading/">Upgrading Rancher</a></li>
           <li><a href="/docs/rancher/v1.6/en/upgrading/#rancher-server-tags">Rancher Server Tags</a></li>
           <li><a href="/docs/rancher/v1.6/en/upgrading/#infrastructure-services">Upgrading Infrastructure Services</a></li>
           <li><a href="/docs/rancher/v1.6/en/upgrading/#multi-nodes">Upgrading Rancher HA Setup</a></li>
           <li><a href="/docs/rancher/v1.6/en/upgrading/#single-container-external-database">Using an external DB</a></li>
           <li><a href="/docs/rancher/v1.6/en/upgrading/#single-container-bind-mount">Bind Mounted MySQL Volume</a></li>
           <li><a href="/docs/rancher/v1.6/en/upgrading/#rancher-server-with-no-internet-access">No Internet Access</a></li>
        </ul>
     </li>
    <li>
         <a href="#">Rancher Configuration<i class="pull-right fa fa-angle-down"></i></a>
         <ul>
           <li>
                <a href="#">Access Control Providers<i class="pull-right fa fa-angle-down"></i></a>
                <ul>
                  <li><a href="/docs/rancher/v1.6/en/configuration/access-control/#active-directory">Active Directory</a></li>
                  <li><a href="/docs/rancher/v1.6/en/configuration/access-control/#azure-ad">Azure AD</a></li>
                  <li><a href="/docs/rancher/v1.6/en/configuration/access-control/#github">Github</a></li>
                  <li><a href="/docs/rancher/v1.6/en/configuration/access-control/#local-authentication">Local Authentication</a></li>
                  <li><a href="/docs/rancher/v1.6/en/configuration/access-control/#openldap">OpenLDAP</a></li>
                  <li><a href="/docs/rancher/v1.6/en/configuration/access-control/#shibboleth">Shibboleth/SAML</a></li>
                </ul>
          </li>
          <li><a href="/docs/rancher/v1.6/en/configuration/access-control/#site-access">Rancher Site Access</a></li>
          <li><a href="/docs/rancher/v1.6/en/configuration/access-control/#restricting-concurrent-sessions">Restricting Concurrent Sessions</a></li>
          <li><a href="/docs/rancher/v1.6/en/configuration/accounts/">Accounts</a></li>
          <li><a href="/docs/rancher/v1.6/en/configuration/settings/#host-registration">Host Registration</a></li>
          <li><a href="/docs/rancher/v1.6/en/configuration/settings/#catalog">Enabling Catalogs</a></li>
          <li><a href="/docs/rancher/v1.6/en/configuration/machine-drivers/">Machine Drivers</a></li>
        </ul>
    </li>
    <li>
          <a href="#">Environments<i class="pull-right fa fa-angle-down"></i></a>
          <ul>
            <li><a href="/docs/rancher/v1.6/en/environments/">Managing Environments</a></li>
            <li><a href="/docs/rancher/v1.6/en/environments/#what-is-an-environment-template">Environment Templates</a></li>
            <li><a href="/docs/rancher/v1.6/en/environments/#membership-roles">Roles in an Environment</a></li>
          </ul>
    </li>
    <li>
        <a href="#">Hosts<i class="pull-right fa fa-angle-down"></i></a>
        <ul>
          <li><a href="/docs/rancher/v1.6/en/hosts/">Getting Started with Hosts</a></li>
          <li><a href="/docs/rancher/v1.6/en/hosts/#supported-docker-versions">Supported Docker Versions</a></li>
          <li><a href="/docs/rancher/v1.6/en/hosts/#host-labels">Adding Host Labels</a></li>
          <li><a href="/docs/rancher/v1.6/en/hosts/#scheduler-ips">Adding Scheduler IPs</a></li>
          <li><a href="/docs/rancher/v1.6/en/hosts/#hosts-behind-an-http-proxy">Behind an HTTP Proxy</a></li>
          <li><a href="/docs/rancher/v1.6/en/hosts/custom/">Adding Custom Hosts</a></li>
          <li>
              <a href="#">Adding Cloud Provided Hosts<i class="pull-right fa fa-angle-down"></i></a>
              <ul>
                <li><a href="/docs/rancher/v1.6/en/hosts/amazon/">Adding Amazon EC2 Hosts</a></li>
                <li><a href="/docs/rancher/v1.6/en/hosts/azure/">Adding Azure Hosts</a></li>
                <li><a href="/docs/rancher/v1.6/en/hosts/digitalocean/">Adding DigitalOcean Hosts</a></li>
                <li><a href="/docs/rancher/v1.6/en/hosts/exoscale/">Adding Exoscale Hosts</a></li>
                <li><a href="/docs/rancher/v1.6/en/hosts/packet/">Adding Packet Hosts</a></li>
                <li><a href="/docs/rancher/v1.6/en/hosts/rackspace/">Adding Rackspace Hosts</a></li>
                <li><a href="/docs/rancher/v1.6/en/hosts/other/">Adding Hosts from Other Cloud Providers</a></li>
              </ul>
          </li>
          <li><a href="/docs/rancher/v1.6/en/hosts/#accessing-hosts-from-the-cloud-providers">Accessing Cloud Provided Hosts</a></li>
          <li><a href="/docs/rancher/v1.6/en/hosts/#removing-hosts">Removing Hosts</a></li>
        </ul>
    </li>
    <li>
      <a href="#">Registries<i class="pull-right fa fa-angle-down"></i></a>
      <ul>
        <li><a href="/docs/rancher/v1.6/en/environments/registries/">Adding Private Registries</a></li>
        <li><a href="/docs/rancher/v1.6/en/environments/registries/#insecure-registries">Insecure Registries</a></li>
        <li><a href="/docs/rancher/v1.6/en/environments/registries/#self-signed-certificates">Self Signed Certificates</a></li>
        <li><a href="/docs/rancher/v1.6/en/environments/registries/#using-amazons-ecr-registry">Using Amazon's ECR</a></li>
        <li><a href="/docs/rancher/v1.6/en/environments/registries/#using-google-container-registry">Using Google Container Registry</a></li>
        <li><a href="/docs/rancher/v1.6/en/environments/registries/#changing-the-default-registry">Changing the Default Registry</a></li>
        <li><a href="/docs/rancher/v1.6/en/environments/registries/#limiting-which-registries-can-be-used">Limiting Registries</a></li>
      </ul>
    </li>
    <li><a href="/docs/rancher/v1.6/en/environments/certificates/">Certificates</a></li>
    <li>
      <a href="#">Infrastructure Services<i class="pull-right fa fa-angle-down"></i></a>
          <ul>
              <li><a href="/docs/rancher/v1.6/en/rancher-services/">Infrastructure Services</a></li>
              <li><a href="/docs/rancher/v1.6/en/rancher-services/networking/">Networking</a></li>
              <li><a href="/docs/rancher/v1.6/en/rancher-services/network-policy/">Network Policies</a></li>
              <li><a href="/docs/rancher/v1.6/en/rancher-services/load-balancer">Load Balancer</a></li>
              <li><a href="/docs/rancher/v1.6/en/rancher-services/dns-service/">DNS Service</a></li>
              <li><a href="/docs/rancher/v1.6/en/rancher-services/metadata-service/">Metadata Service</a></li>
              <li>
                  <a href="#">Persistent Storage Service<i class="pull-right fa fa-angle-down"></i></a>
                  <ul>
                      <li><a href="/docs/rancher/v1.6/en/rancher-services/storage-service/">Persistent Storage Service</a></li>
                      <li><a href="/docs/rancher/v1.6/en/rancher-services/storage-service/rancher-nfs/">Rancher NFS</a></li>
                      <li><a href="/docs/rancher/v1.6/en/rancher-services/storage-service/rancher-ebs/">Rancher EBS</a></li>
                  </ul>
              </li>
              <li>
                  <a href="#">External Scheduler<i class="pull-right fa fa-angle-down"></i></a>
                  <ul>
                      <li><a href="/docs/rancher/v1.6/en/rancher-services/scheduler/">External Scheduler</a></li>
                      <li><a href="/docs/rancher/v1.6/en/rancher-services/scheduler/#multiple-ips">Scheduling against multiple IPs</a></li>
                      <li><a href="/docs/rancher/v1.6/en/rancher-services/scheduler/#resource-constraints">Scheduling with Resource Constraints</a></li>
                      <li><a href="/docs/rancher/v1.6/en/rancher-services/scheduler/#restrict-services-on-host">Scheduling only Specific Services on a Host</a></li>
                  </ul>
              </li>
              <li><a href="/docs/rancher/v1.6/en/rancher-services/audit-log/">Audit Logging</a></li>
              <li><a href="/docs/rancher/v1.6/en/rancher-services/service-accounts/">Service Accounts</a></li>
           </ul>
    </li>
    <li>
          <a href="#">Cattle<i class="pull-right fa fa-angle-down"></i></a>
          <ul>
                <li><a href="/docs/rancher/v1.6/en/cattle/stacks/">Stacks</a></li>
                <li><a href="/docs/rancher/v1.6/en/cattle/adding-services/">Services</a></li>
                <li><a href="/docs/rancher/v1.6/en/cattle/volumes/">Volumes</a></li>
                <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/">Load Balancers</a></li>
                <li>
                    <a href="#">Load Balancer Options in the UI<i class="pull-right fa fa-angle-down"></i></a>
                    <ul>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#adding-a-load-balancer-in-the-ui">Adding Load Balancers</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#service-rule">Targeting Specific Services</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#selector-rule">Targeting Services based on Selectors</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#ssl-termination">SSL Termination</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#stickiness-policy-for-load-balancers">Stickiness Policy</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#custom-haproxy-configuration">Custom HAProxy Configuration</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#labelsscheduling-load-balancers">Labels and Scheduling</a></li>
                      </ul>
                </li>
                <li>
                    <a href="#">Load Balancer Options with CLI and Compose<i class="pull-right fa fa-angle-down"></i></a>
                    <ul>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#adding-a-load-balancer-with-rancher-compose">Adding Load Balancers</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#source-ports">Defining Source Ports</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#port-rules">Port Rules</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#certificates">Certificates</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#custom-configuration">Custom HAProxy Configuration</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#stickiness-policy">Stickiness Policy</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#load-balancer-example-l7">Example of L7 Load Balancer</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#internal-load-balancer-example">Example of Internal Load Balancer</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#ssl-termination-example">Example of SSL Termination with a Load Balancer</a></li>
                      </ul>
                </li>
                <li><a href="/docs/rancher/v1.6/en/cattle/adding-external-services/">External Services</a></li>
                <li><a href="/docs/rancher/v1.6/en/cattle/adding-service-alias/">Service Alias</a></li>
                <li><a href="/docs/rancher/v1.6/en/cattle/health-checks/">Health Checks</a></li>
                <li>
                    <a href="#">Scheduling Services<i class="pull-right fa fa-angle-down"></i></a>
                    <ul>
                        <li><a href="/docs/rancher/v1.6/en/cattle/scheduling/">Scheduling</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/scheduling/#scheduling-options-in-the-ui">Scheduling in the UI</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/scheduling/#adding-labels-in-rancher-compose">Scheduling in Rancher Compose</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/scheduling/#table-of-scheduling-labels">Table of Scheduling Labels</a></li>
                    </ul>
                </li>
                <li><a href="/docs/rancher/v1.6/en/cattle/upgrading/">Upgrading Services</a></li>
                <li><a href="/docs/rancher/v1.6/en/cattle/internal-dns-service/">Internal DNS Service in Cattle Environments</a></li>
                <li><a href="/docs/rancher/v1.6/en/cattle/external-dns-service/">External DNS Service</a></li>
                <li>
                    <a href="#">Rancher-Compose<i class="pull-right fa fa-angle-down"></i></a>
                    <ul>
                        <li><a href="/docs/rancher/v1.6/en/cattle/rancher-compose/">Rancher Compose</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/rancher-compose/commands/">Commands and Options</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/rancher-compose/environment-interpolation/">Environment Interpolation</a></li>
                        <li><a href="/docs/rancher/v1.6/en/cattle/rancher-compose/build/">Building with AWS S3</a></li>
                    </ul>
                </li>
                <li><a href="/docs/rancher/v1.6/en/cattle/secrets/">Secrets - Experimental</a></li>
                <li><a href="/docs/rancher/v1.6/en/cattle/webhook-service/">Webhooks</a></li>
                <li><a href="/docs/rancher/v1.6/en/cattle/labels/">Labels in Cattle</a></li>
          </ul>
    </li>
    <li>
          <a href="#">Kubernetes<i class="pull-right fa fa-angle-down"></i></a>
          <ul>
              <li><a href="/docs/rancher/v1.6/en/kubernetes/">Launching Kubernetes</a></li>
              <li><a href="/docs/rancher/v1.6/en/kubernetes/resiliency-planes/">Resiliency Planes</a></li>
              <li><a href="/docs/rancher/v1.6/en/kubernetes/providers/">Cloud Providers</a></li>
              <li><a href="/docs/rancher/v1.6/en/kubernetes/private-registry/">Private Registry</a></li>
              <li><a href="/docs/rancher/v1.6/en/kubernetes/rbac/">RBAC</a></li>
              <li><a href="/docs/rancher/v1.6/en/kubernetes/disaster-recovery/">Disaster Recovery</a></li>
              <li><a href="/docs/rancher/v1.6/en/kubernetes/backups/">Backups</a></li>
              <li><a href="/docs/rancher/v1.6/en/kubernetes/storage/">Persistent Storage</a></li>
              <li>
                  <a href="#">Add-ons Support<i class="pull-right fa fa-angle-down"></i></a>
                  <ul>
                      <li><a href="/docs/rancher/v1.6/en/kubernetes/addons/">Add-ons Support</a></li>
                      <li><a href="/docs/rancher/v1.6/en/kubernetes/addons/#helm">Helm</a></li>
                      <li><a href="/docs/rancher/v1.6/en/kubernetes/addons/#skydns">SkyDNS</a></li>
                  </ul>
              </li>
              <li>
                  <a href="#">Ingress Support and Options<i class="pull-right fa fa-angle-down"></i></a>
                  <ul>
                      <li><a href="/docs/rancher/v1.6/en/kubernetes/ingress/">Ingress Support</a></li>
                      <li><a href="/docs/rancher/v1.6/en/kubernetes/ingress/#host-based-routing">Host Based Routing</a></li>
                      <li><a href="/docs/rancher/v1.6/en/kubernetes/ingress/#path-based-routing">Path Based Routing</a></li>
                      <li><a href="/docs/rancher/v1.6/en/kubernetes/ingress/#scale-and-other-port">Multiple Load Balancers and Selecting Ports</a></li>
                      <li><a href="/docs/rancher/v1.6/en/kubernetes/ingress/#tls">Using TLS</a></li>
                      <li><a href="/docs/rancher/v1.6/en/kubernetes/ingress/#blocking-http">Blocking HTTP</a></li>
                      <li><a href="/docs/rancher/v1.6/en/kubernetes/ingress/#custom-haproxy">Custom HAProxy</a></li>
                      <li><a href="/docs/rancher/v1.6/en/kubernetes/ingress/#scheduled-globally">Scheduling on all Hosts</a></li>
                      <li><a href="/docs/rancher/v1.6/en/kubernetes/ingress/#host-scheduling">Scheduling on a specific Host</a></li>
                      <li><a href="/docs/rancher/v1.6/en/kubernetes/ingress/#only-local">Targeting Only Containers on the Same Host</a></li>
                      <li><a href="/docs/rancher/v1.6/en/kubernetes/ingress/#prefer-local">Prioritizing Containers on the Same Host</a></li>
                  </ul>
              </li>
              <li><a href="/docs/rancher/v1.6/en/kubernetes/upgrading/">Upgrading Kubernetes</a></li>
              <li><a href="/docs/rancher/v1.6/en/kubernetes/deleting/">Deleting Kubernetes</a></li>

          </ul>
    </li>
    <li><a href="/docs/rancher/v1.6/en/mesos/">Mesos</a></li>
    <li><a href="/docs/rancher/v1.6/en/swarm/">Swarm - Experimental </a></li>
    <li><a href="/docs/rancher/v1.6/en/windows/">Windows - Experimental</a></li>
    <li><a href="/docs/rancher/v1.6/en/native-docker/">Using Native Docker CLI</a></li>
    <li>
            <a href="#">Rancher Catalog<i class="pull-right fa fa-angle-down"></i></a>
            <ul>
                <li><a href="/docs/rancher/v1.6/en/catalog/">Catalog</a></li>
                <li><a href="/docs/rancher/v1.6/en/catalog/private-catalog/">Creating Private Catalogs</a></li>
            </ul>
        </li>
    <li><a href="#">Rancher CLI<i class="pull-right fa fa-angle-down"></i></a>
        <ul>
            <li><a href="/docs/rancher/v1.6/en/cli/">Rancher CLI</a></li>
            <li><a href="/docs/rancher/v1.6/en/cli/commands/">Commands and Options</a></li>
            <li><a href="/docs/rancher/v1.6/en/cli/variable-interpolation/">Variable Interpolation</a></li>
        </ul>
    </li>
    <li><a href="/docs/rancher/v1.6/en/api/v2-beta/">API Documentation</a></li>
    <li><a href="/docs/rancher/v1.6/en/contributing/">Contributing to Rancher</a></li>
    <li>
        <a href="#">FAQs<i class="pull-right fa fa-angle-down"></i></a>
        <ul>
            <li><a href="/docs/rancher/v1.6/en/faqs/server/">FAQs about Rancher Server</a></li>
            <li><a href="/docs/rancher/v1.6/en/faqs/agents/">FAQs about Rancher Agents/Hosts</a></li>
            <li><a href="/docs/rancher/v1.6/en/faqs/troubleshooting/">Troubleshooting FAQS</a></li>
        </ul>
    </li>
    <li>
        <a href="#">Docs Archive<i class="pull-right fa fa-angle-down"></i></a>
        <ul>
            <li><a href="/docs/rancher/v1.5/en/">Rancher v1.5</a></li>
            <li><a href="/docs/rancher/v1.4/en/">Rancher v1.4</a></li>
            <li><a href="/docs/rancher/v1.3/en/">Rancher v1.3</a></li>
            <li><a href="/docs/rancher/v1.2/en/">Rancher v1.2</a></li>
            <li><a href="/docs/rancher/v1.1/en/">Rancher v1.1</a></li>
            <li><a href="/docs/rancher/v1.0/en/">Rancher v1.0</a></li>
        </ul>
    </li>
</ul>

      </div>

      <div class="col span-8">
        <div class="content-container">
          <h2 id="load-balancers">Load Balancers</h2>
<hr />

<p>Rancher provides the ability to use different load balancer drivers within Rancher. A load balancer can be used to distribute network and application traffic to individual containers by adding rules to target services. Any target service will have all its underlying containers automatically registered as load balancer targets by Rancher. With Rancher, it’s easy to add a load balancer to your stack.</p>

<p>By default, Rancher has provided a managed load balancer using HAProxy that can be manually scaled to multiple hosts. The rest of our examples in this document will cover the different options for load balancers, but specifically referencing our HAProxy load balancer service. We are planning to add in additional load balancer providers, and the options for all load balancers will be the same regardless of load balancer provider.</p>

<p>We use a round robin algorithm to distribute traffic to the target services. The algorithm can be customized in the <a href="#custom-haproxy-configuration">custom HAProxy configuration</a>. Alternatively, you can configure the load balancer to route traffic to target containers that are on the same host as the load balancer container. By adding a <a href="/docs/rancher/v1.6/en/cattle/scheduling/#target-service-labels">specific label</a> to the load balancer, it will configure the load balancer to target either only the container on the same host as the load balancer (i.e. <code class="highlighter-rouge">io.rancher.lb_service.target=only-local</code>) or prioritize these containers over containers on a different host (i.e. <code class="highlighter-rouge">io.rancher.lb_service.target=prefer-local</code>).</p>

<p>We’ll review the options for our load balancer for the <a href="#load-balancer-options-in-the-UI">UI</a> and <a href="#load-balancer-options-in-rancher-compose">Rancher Compose</a> and show examples using the <a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#adding-a-load-balancer-in-the-ui">UI</a> and <a href="/docs/rancher/v1.6/en/cattle/adding-load-balancers/#adding-a-load-balancer-with-rancher-compose">Rancher Compose</a>.</p>

<h3 id="adding-a-load-balancer-in-the-ui">Adding a Load Balancer in the UI</h3>

<p>We’ll walk through how to set up a load balancer for our “letschat” application created earlier in the <a href="/docs/rancher/v1.6/en/cattle/adding-services/#adding-services-in-the-ui">adding services section</a>.</p>

<p>First, you start by creating a load balancer, by clicking on the dropdown icon next to “Add Service” and clicking <strong>Add Load Balancer</strong>. By default, the scale will be of 1 container. Provide a name like “LetsChatLB”.</p>

<p>For the port rules, use the default <code class="highlighter-rouge">Public</code> access, the default <code class="highlighter-rouge">http</code> protocol, a source port of <code class="highlighter-rouge">80</code>, select the “letschat” service, and use a target port of <code class="highlighter-rouge">8080</code>. Click on <strong>Create</strong>.</p>

<p>Now, let’s see the load balancer in action. In the stack view, there is a link to  port <code class="highlighter-rouge">80</code> that you’ve used as the source port for your load balancer. If you click on it, it will automatically bring up a new tab in your browser and point to one of the hosts that has the load balancer launched. The request is re-directed to one of the “LetsChat” containers. If you were to refresh, the load balancer would redirect the new request to the other container in the “letschat” service.</p>

<h3 id="load-balancer-options-in-the-ui">Load Balancer Options in the UI</h3>

<p>Rancher provides a load balancer running HAProxy software inside the container to direct traffic to the target services.</p>

<blockquote>
  <p><strong>Note:</strong> Load balancers will only work for services that are using the managed network. If you select any other network choice for your target services, it will <strong>not</strong> work with the load balancer.</p>
</blockquote>

<p>You add a load balancer by clicking the dropdown icon next to the <strong>Add Service</strong> button and selecting <strong>Add Load Balancer</strong>.</p>

<p>You can use the slider to select the scale, i.e. how many containers of the load balancer. Alternatively, you can select <strong>Always run one instance of this container on every host</strong>. With this option, your load balancer will scale for any additional hosts that are added to your <a href="/docs/rancher/v1.6/en/environments/">environment</a>. If you have scheduling rules in the <strong>Scheduling</strong> section, Rancher will only start containers on the hosts that meet the scheduling rules. If you add a host to your environment that does not meet the scheduling rules, a container will not be started on the host.</p>

<blockquote>
  <p><strong>Note:</strong> The scale of the load balancer cannot exceed the number of hosts in the environment, otherwise there will be a port conflict and the load balancer service will be stuck in an activating state. It will continue to try and find an available host and open port until you edit the scale of this load balancer or <a href="/docs/rancher/v1.6/en/hosts/">add additional hosts</a>.</p>
</blockquote>

<p>You will need to provide a <strong>Name</strong> and if desired, <strong>Description</strong> of the load balancer.</p>

<p>Next, you’ll define the port rules for a load balancer. There are two types of port rules that can be created. There are service rules that target existing services and selector rules that will target services that match the selector criteria.</p>

<p>When creating service and selector rules, the hostname and path rules are matched top-to-bottom in the order shown in the UI.</p>

<h4 id="service-rule">Service rule</h4>

<p>Service rules are port rules to target existing services in Rancher.</p>

<p>In the <strong>Access</strong> section, you will decide if this load balancer port will be accessible publicly (i.e. accessible outside of the host) or only internally in the environment. By default, Rancher has assumed you want the port to be public, but you can select <code class="highlighter-rouge">Internal</code> if you want the port to only be accessed by services within the same environment.</p>

<p>Select the <strong>Protocol</strong>. Read more about our <a href="#protocol">protocol options</a>.  If you choose to select a protocol that requires SSL termination (i.e. <code class="highlighter-rouge">https</code> or <code class="highlighter-rouge">tls</code>), you will add in your certificates in the <strong>SSL Termination</strong> tab.</p>

<p>Next, you’ll provide the <strong>request host</strong>, <strong>source port</strong> and <strong>path</strong> for where the traffic will be coming from.</p>

<blockquote>
  <p><strong>Note:</strong> Port <code class="highlighter-rouge">42</code> cannot be used as a source port for load balancers because Rancher uses this port for <a href="/docs/rancher/v1.6/en/cattle/health-checks">health checks</a>.</p>
</blockquote>

<h5 id="request-hostpath">Request Host/Path</h5>

<p>The request host can be a specific HTTP host header for each service. The request path can be a specific path. The request host and request path can be used independently or in conjunction to create a specific request.</p>

<h6 id="example">Example:</h6>

<div class="highlighter-rouge"><pre class="highlight"><code>domain1.com -&gt; Service1
domain2.com -&gt; Service2

domain3.com -&gt; Service1
domain3.com/admin -&gt; Service2
</code></pre>
</div>

<h6 id="wildcards">Wildcards</h6>

<p>Rancher supports wildcards when adding host based routing. The following wildcard syntax is supported.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>*.domain.com -&gt; hdr_end(host) -i .domain.com
domain.com.* -&gt; hdr_beg(host) -i domain.com.
</code></pre>
</div>

<h5 id="target-service-and-port">Target Service and Port</h5>

<p>For each service rule, you select the specific <strong>target</strong> service to direct traffic to. The list of services is based on all the services within that environment. Along with the service, you select which <strong>port</strong> to direct the traffic to on the service. This private port on the service is typically the exposed port on the image.</p>

<h4 id="selector-rule">Selector rule</h4>

<p>For a selector rule, instead of targeting a specific service, you would provide a <a href="/docs/rancher/v1.6/en/cattle/labels/#selector-labels">selector value</a>. The selector is used to pick up target services based on the labels of a service. When the load balancer is created, the selector rules will be evaluated against any existing services in the environment to see if there are any existing target services. Any additional services or changes to labels on a service would be compared against the selector values to see if the service should be a target service.</p>

<p>For each <strong>source port</strong>, you can add in <strong>request host</strong> and/or <strong>path</strong>. The <a href="/docs/rancher/v1.6/en/cattle/labels/#selector-labels">selector value</a> is provided under <strong>target</strong> and you can provide a specific <strong>port</strong> to direct the traffic to on the service. This private port on the service is typically the exposed port on the image.</p>

<h5 id="example-2-selector-rules">Example: 2 Selector Rules</h5>

<ol>
  <li>Source Port: <code class="highlighter-rouge">100</code>; Selector: <code class="highlighter-rouge">foo=bar</code>; Port: <code class="highlighter-rouge">80</code></li>
  <li>Source Port: <code class="highlighter-rouge">200</code>; Selector: <code class="highlighter-rouge">foo1=bar1</code>; Port: <code class="highlighter-rouge">80</code></li>
</ol>

<ul>
  <li>Service A has a <code class="highlighter-rouge">foo=bar</code> label and would match the first selector rule. Any traffic to <code class="highlighter-rouge">100</code> would be directed to Service A.</li>
  <li>Service B has a <code class="highlighter-rouge">foo1=bar</code> label and would match the second selector rule. Any traffic to <code class="highlighter-rouge">200</code> would be directed to Service B.</li>
  <li>Service C has both <code class="highlighter-rouge">foo=bar</code> and <code class="highlighter-rouge">foo1=bar1</code> labels and match both selector rules. Traffic from either source port would be directed to Service C.</li>
</ul>

<blockquote>
  <p><strong>Note:</strong> Currently, if you want to use one selector source port rule for multiple hostnames/paths, you would need to use <a href="#selector">Rancher Compose</a> to set the hostname/path values on the target services.</p>
</blockquote>

<h4 id="ssl-termination">SSL Termination</h4>

<p>The <strong>SSL Termination</strong> tab provides the ability to add certificates to use for the <code class="highlighter-rouge">https</code> and <code class="highlighter-rouge">tls</code> protocols. In the <strong>Certificate</strong> dropdown, you can select the main certificate for the load balancers.</p>

<p>To add a certificate to Rancher, please read about <a href="/docs/rancher/v1.6/en/environments/certificates/">how to add certificates in the <strong>Infrastructure</strong> tab</a>.</p>

<p>It is possible to provide multiple certificates for the load balancer such that the appropriate certificate is presented to the client based on the hostname requested (see <a href="https://en.wikipedia.org/wiki/Server_Name_Indication">Server Name Indication</a>). This may not work with older clients, which don’t support SNI (those will get the main certificate). For modern clients, they will be offered the certificate from the list for which there is a match or the main certificate if there is no match.</p>

<h4 id="stickiness-policy-for-load-balancers">Stickiness Policy for Load Balancers</h4>

<p>You can select the <strong>Stickiness</strong> of the load balancer. Stickiness is the cookie policy that you want to use for when using cookies of the website.</p>

<p>The two options supported in Rancher are:</p>

<ul>
  <li><strong>None</strong>: This option means that no cookie policy is in place.</li>
  <li><strong>Create new cookie</strong>: This option means that the cookie will be defined outside of your application. This cookie is what the load balancer would set on requests and responses. This cookie would determine the stickiness policy.</li>
</ul>

<h4 id="custom-haproxy-configuration">Custom HAProxy Configuration</h4>

<p>Since Rancher is using an HAProxy specific load balancer, you can customize the HAProxy configuration of the load balancer. Whatever you define in this section will be appended to the configuration generated by Rancher.</p>

<h5 id="example-of-a-custom-haproxy-configuration">Example of a Custom HAProxy Configuration</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>global
    maxconn 4096
    maxpipes 1024

defaults
    log global
    mode    tcp
    option  tcplog

frontend 80
    balance leastconn

frontend 90
    balance roundrobin

backend mystack_foo
    cookie my_cookie insert indirect nocache postonly
    server $IP &lt;server parameters&gt;

backend customUUID
    server $IP &lt;server parameters&gt;
</code></pre>
</div>

<h4 id="labelsscheduling-load-balancers">Labels/Scheduling Load Balancers</h4>

<p>We provide the ability to add labels to load balancers and schedule where the load balancer will be launched. Read more details about labels and scheduling <a href="/docs/rancher/v1.6/en/cattle/scheduling/#scheduling-options-in-the-ui">here</a>.</p>

<h3 id="adding-a-load-balancer-with-rancher-compose">Adding a Load Balancer with Rancher Compose</h3>

<p>We’ll walk through how to set up a load balancer for our “letschat” application created earlier in the <a href="/docs/rancher/v1.6/en/cattle/adding-services/#adding-services-with-rancher-compose">adding services section</a>.</p>

<p>Read more about how to <a href="/docs/rancher/v1.6/en/cattle/rancher-compose/">set up Rancher Compose</a>.</p>

<blockquote>
  <p><strong>Note</strong>: In our examples, we will use <code class="highlighter-rouge">&lt;version&gt;</code> as the image tag for our load balancers. Each version of Rancher will have a specific version of <code class="highlighter-rouge">lb-service-haproxy</code> that is supported for load balancers.</p>
</blockquote>

<p>We’ll set up the same example that we used above in the UI example. To get started, you will need to create a <code class="highlighter-rouge">docker-compose.yml</code> file and a <code class="highlighter-rouge">rancher-compose.yml</code> file. With Rancher Compose, we can launch the load balancer.</p>

<h4 id="example-docker-composeyml">Example <code class="highlighter-rouge">docker-compose.yml</code></h4>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">letschatlb</span><span class="pi">:</span>
    <span class="s">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">80</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">rancher/lb-service-haproxy:&lt;version&gt;</span>
</code></pre>
</div>

<h4 id="example-rancher-composeyml">Example <code class="highlighter-rouge">rancher-compose.yml</code></h4>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">letschatlb</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">lb_config</span><span class="pi">:</span>
      <span class="s">port_rules</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">source_port</span><span class="pi">:</span> <span class="s">80</span>
        <span class="s">target_port</span><span class="pi">:</span> <span class="s">8080</span>
        <span class="s">service</span><span class="pi">:</span> <span class="s">letschat</span>
    <span class="s">health_check</span><span class="pi">:</span>
      <span class="s">port</span><span class="pi">:</span> <span class="s">42</span>
      <span class="s">interval</span><span class="pi">:</span> <span class="s">2000</span>
      <span class="s">unhealthy_threshold</span><span class="pi">:</span> <span class="s">3</span>
      <span class="s">healthy_threshold</span><span class="pi">:</span> <span class="s">2</span>
      <span class="s">response_timeout</span><span class="pi">:</span> <span class="s">2000</span>
</code></pre>
</div>

<h3 id="load-balancer-options-in-rancher-compose">Load Balancer Options in Rancher Compose</h3>

<p>Rancher provides a load balancer running HAProxy software inside the container to direct traffic to the target services.</p>

<blockquote>
  <p><strong>Note:</strong> Load balancers will only work for services that are using the managed network. If you select any other network choice for your target services, it will <strong>not</strong> work with the load balancer.</p>
</blockquote>

<p>A load balancer can be scheduled like any other service. Read more about <a href="/docs/rancher/v1.6/en/cattle/scheduling/#adding-labels-in-rancher-compose">scheduling</a> load balancers using Rancher Compose.</p>

<p>Load balancing is configured with a combination of ports exposed on a host and a load balancer configuration, which can include specific port rules for each target service, custom configuration and stickiness policies.</p>

<p>When working with services that contain <a href="/docs/rancher/v1.6/en/cattle/adding-services/#sidekick-services">sidekicks</a>, you need to use the <a href="/docs/rancher/v1.6/en/cattle/adding-services/#primary-service">primary service</a> as a target service, which is the service that contains the <code class="highlighter-rouge">sidekick</code> label.</p>

<h3 id="source-ports">Source Ports</h3>

<p>When creating a load balancer, you can add any ports you want exposed on the host. Any of these ports can be used as source ports in the port rules of a load balancer. If you want an internal load balancer, you would not expose any ports on the load balancer, and only add in port rules in the load balancer configuration.</p>

<blockquote>
  <p><strong>Note:</strong>  Port <code class="highlighter-rouge">42</code> cannot be used as a port for load balancers because it’s internally used for <a href="/docs/rancher/v1.6/en/cattle/health-checks">health checks</a>.</p>
</blockquote>

<h4 id="example-docker-composeyml-1">Example <code class="highlighter-rouge">docker-compose.yml</code></h4>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb1</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">rancher/lb-service-haproxy:&lt;version&gt;</span>
    <span class="c1"># Any ports listed will be exposed on the host that is running the load balancer</span>
    <span class="c1"># To direct traffic to specific service, a port rule will need to be added.</span>
    <span class="s">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">80</span>
    <span class="pi">-</span> <span class="s">81</span>
    <span class="pi">-</span> <span class="s">90</span>
</code></pre>
</div>

<h3 id="load-balancer-configuration">Load Balancer configuration</h3>

<p>All load balancer configuration options are defined in the <code class="highlighter-rouge">rancher-compose.yml</code> under the <code class="highlighter-rouge">lb_config</code> key.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb1</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="c1"># All load balancer options are configured in this key</span>
    <span class="s">lb_config</span><span class="pi">:</span>
      <span class="s">port_rules</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">source_port</span><span class="pi">:</span> <span class="s">80</span>
        <span class="s">target_port</span><span class="pi">:</span> <span class="s">80</span>
        <span class="s">service</span><span class="pi">:</span> <span class="s">web1</span>
    <span class="s">health_check</span><span class="pi">:</span>
      <span class="s">port</span><span class="pi">:</span> <span class="s">42</span>
      <span class="s">interval</span><span class="pi">:</span> <span class="s">2000</span>
      <span class="s">unhealthy_threshold</span><span class="pi">:</span> <span class="s">3</span>
      <span class="s">healthy_threshold</span><span class="pi">:</span> <span class="s">2</span>
      <span class="s">response_timeout</span><span class="pi">:</span> <span class="s">2000</span>
  <span class="s">web1</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">2</span>
</code></pre>
</div>

<h4 id="port-rules">Port rules</h4>

<p>Port rules are defined in the <code class="highlighter-rouge">rancher-compose.yml</code>. Since port rules are defined individually, there may be multiple port rules defined for the same service. By default, Rancher will prioritize these port rules based on a specific priority ordering. If you would like to change the ordering of the prioritization, you can also set a specific <a href="#priority">priority</a> order of the rules.</p>

<h4 id="default-priority-order">Default Priority Order</h4>

<ol>
  <li>Hostname with no wildcards and URL</li>
  <li>Hostname with no wildcards</li>
  <li>Hostname with wildcards and URL</li>
  <li>Hostname with wildcards</li>
  <li>URL</li>
  <li>Default (no hostname, no URL)</li>
</ol>

<h5 id="source-port">Source Port</h5>

<p>The source port is one of the ports exposed on the host (i.e. a port that is in the <code class="highlighter-rouge">docker-compose.yml</code>).</p>

<p>If you want to create internal load balancer, then the source port does not need to match any of the ports in the <code class="highlighter-rouge">docker-compose.yml</code> file.</p>

<h5 id="target-port">Target Port</h5>

<p>The target port is the private port on the service. This port correlates to the port exposed on the image used to start your service.</p>

<h5 id="protocol">Protocol</h5>

<p>There are multiple protocol types that are supported in the Rancher load balancer drivers.</p>

<ul>
  <li><code class="highlighter-rouge">http</code> - By default, if no protocol is set, the load balancer uses <code class="highlighter-rouge">http</code>. HAProxy doesn’t decrypt the traffic and passes the traffic directly through</li>
  <li><code class="highlighter-rouge">tcp</code> - HAProxy doesn’t decrypt the traffic and passes the traffic directly through</li>
  <li><code class="highlighter-rouge">https</code> - SSL termination is required. Traffic is decrypted by HAProxy using the provided <a href="/docs/rancher/v1.6/en/environments/certificates/">certificates</a>, which must be added into Rancher before being used in a load balancer. Traffic from the load balancer to the target service is unencrypted.</li>
  <li><code class="highlighter-rouge">tls</code> - SSL termination is required. Traffic is decrypted by HAProxy using the provided <a href="/docs/rancher/v1.6/en/environments/certificates/">certificates</a>, which must be added into Rancher before being used in a load balancer. Traffic from the load balancer to the target service is unencrypted.</li>
  <li><code class="highlighter-rouge">sni</code> - Traffic is encrypted to the load balancer and to the services. Multiple certificates are provided for the load balancer such that the appropriate certificate is presented to the client based on the hostname requested. (see <a href="https://en.wikipedia.org/wiki/Server_Name_Indication">Server Name Indication</a> for more details).</li>
  <li><code class="highlighter-rouge">udp</code> - This is not supported for Rancher’s HAProxy provider.</li>
</ul>

<p>Any additional load balancer providers might support only a subset of the protocols.</p>

<h5 id="hostname-routing">Hostname Routing</h5>

<p>Hostname routing is only supported for <code class="highlighter-rouge">http</code>, <code class="highlighter-rouge">https</code> and <code class="highlighter-rouge">sni</code>. Only <code class="highlighter-rouge">http</code> and <code class="highlighter-rouge">https</code> support path based routing as well.</p>

<h5 id="service">Service</h5>

<p>The service name that you want the load balancer to direct traffic to. If the service is in the same stack, then you use the service name. If the service is in a different stack, then you would use <code class="highlighter-rouge">&lt;stack_name&gt;/&lt;service_name&gt;</code>.</p>

<h6 id="example-rancher-composeyml-1">Example <code class="highlighter-rouge">rancher-compose.yml</code></h6>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb1</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">lb_config</span><span class="pi">:</span>
      <span class="s">port_rules</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">source_port</span><span class="pi">:</span> <span class="s">81</span>
        <span class="s">target_port</span><span class="pi">:</span> <span class="s">2368</span>
        <span class="c1"># Service in the same stack</span>
        <span class="s">service</span><span class="pi">:</span> <span class="s">ghost</span>
      <span class="pi">-</span> <span class="s">source_port</span><span class="pi">:</span> <span class="s">80</span>
        <span class="s">target_port</span><span class="pi">:</span> <span class="s">80</span>
        <span class="c1"># Target a service in a different stack</span>
        <span class="s">service</span><span class="pi">:</span> <span class="s">differentstack/web1</span>
    <span class="s">health_check</span><span class="pi">:</span>
      <span class="s">port</span><span class="pi">:</span> <span class="s">42</span>
      <span class="s">interval</span><span class="pi">:</span> <span class="s">2000</span>
      <span class="s">unhealthy_threshold</span><span class="pi">:</span> <span class="s">3</span>
      <span class="s">healthy_threshold</span><span class="pi">:</span> <span class="s">2</span>
      <span class="s">response_timeout</span><span class="pi">:</span> <span class="s">2000</span>
  <span class="s">ghost</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">2</span>
</code></pre>
</div>

<h5 id="hostname-and-path">Hostname and Path</h5>

<p>Rancher’s HAProxy load balancer supports L7 load balancing by being able to specify host header and path in the port rules.</p>

<h6 id="example-rancher-composeyml-2">Example <code class="highlighter-rouge">rancher-compose.yml</code></h6>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb1</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">lb_config</span><span class="pi">:</span>
      <span class="s">port_rules</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">source_port</span><span class="pi">:</span> <span class="s">81</span>
        <span class="s">target_port</span><span class="pi">:</span> <span class="s">2368</span>
        <span class="s">service</span><span class="pi">:</span> <span class="s">ghost</span>
        <span class="s">protocol</span><span class="pi">:</span> <span class="s">http</span>
        <span class="s">hostname</span><span class="pi">:</span> <span class="s">example.com</span>
        <span class="s">path</span><span class="pi">:</span> <span class="s">/path/a</span>
    <span class="s">health_check</span><span class="pi">:</span>
      <span class="s">port</span><span class="pi">:</span> <span class="s">42</span>
      <span class="s">interval</span><span class="pi">:</span> <span class="s">2000</span>
      <span class="s">unhealthy_threshold</span><span class="pi">:</span> <span class="s">3</span>
      <span class="s">healthy_threshold</span><span class="pi">:</span> <span class="s">2</span>
      <span class="s">response_timeout</span><span class="pi">:</span> <span class="s">2000</span>
  <span class="s">ghost</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">2</span>
</code></pre>
</div>

<h5 id="wildcards-1">Wildcards</h5>

<p>Rancher supports wildcards when adding host based routing. The following wildcard syntax is supported.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>*.domain.com -&gt; hdr_end(host) -i .domain.com
domain.com.* -&gt; hdr_beg(host) -i domain.com.
</code></pre>
</div>

<h5 id="priority">Priority</h5>

<p>By default, Rancher <a href="#default-priority-order">prioritizes port rules</a> targeting the same service, but if you wanted to, you could customize your own prioritization of the port rules (lower number is higher priority).</p>

<h6 id="example-rancher-composeyml-3">Example <code class="highlighter-rouge">rancher-compose.yml</code></h6>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb1</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">lb_config</span><span class="pi">:</span>
      <span class="s">port_rules</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">source_port</span><span class="pi">:</span> <span class="s">88</span>
        <span class="s">target_port</span><span class="pi">:</span> <span class="s">2368</span>
        <span class="s">service</span><span class="pi">:</span> <span class="s">web1</span>
        <span class="s">protocol</span><span class="pi">:</span> <span class="s">http</span>
        <span class="s">hostname</span><span class="pi">:</span> <span class="s">foo.com</span>
        <span class="s">priority</span><span class="pi">:</span> <span class="s">2</span>
      <span class="pi">-</span> <span class="s">source_port</span><span class="pi">:</span> <span class="s">80</span>
        <span class="s">target_port</span><span class="pi">:</span> <span class="s">80</span>
        <span class="s">service</span><span class="pi">:</span> <span class="s">web2</span>
        <span class="s">protocol</span><span class="pi">:</span> <span class="s">http</span>
        <span class="s">priority</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">health_check</span><span class="pi">:</span>
      <span class="s">port</span><span class="pi">:</span> <span class="s">42</span>
      <span class="s">interval</span><span class="pi">:</span> <span class="s">2000</span>
      <span class="s">unhealthy_threshold</span><span class="pi">:</span> <span class="s">3</span>
      <span class="s">healthy_threshold</span><span class="pi">:</span> <span class="s">2</span>
      <span class="s">response_timeout</span><span class="pi">:</span> <span class="s">2000</span>
  <span class="s">web1</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">2</span>
</code></pre>
</div>

<h5 id="selector">Selector</h5>

<p>Instead of targeting a specific service, you can set up a <a href="(/docs/rancher/v1.6/en/cattle/labels/#selector-labels)">selector</a>. By using selectors, you can define the service links and hostname routing rules on the target service instead of on the load balancer. Services with labels matching the selector become a target in the load balancer.</p>

<p>When using a selector in a load balancer, the <code class="highlighter-rouge">lb_config</code> can be set on the load balancer and any  target services that are matching the selector.</p>

<p>In the load balancer, the <a href="/docs/rancher/v1.6/en/cattle/labels/#selector-labels">selector value</a> is set in the <code class="highlighter-rouge">lb_config</code> under <code class="highlighter-rouge">selector</code>. The port rule in the <code class="highlighter-rouge">lb_config</code> of the load balancer cannot have a service and would typically not have a target port. Instead, the target port is set in port rules on the target service. If you choose to use hostname routing, the hostname and path would be set on the target service.</p>

<blockquote>
  <p><strong>Note:</strong> For any load balancers using the v1 load balancer yaml fields that uses selector labels will not be converted to the v2 load balancer as the port rules on the service would not be updated.</p>
</blockquote>

<h6 id="example-docker-composeyml-2">Example <code class="highlighter-rouge">docker-compose.yml</code></h6>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb1</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">rancher/lb-service-haproxy:&lt;version&gt;</span>
    <span class="s">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">81</span>
  <span class="c1"># These services (web1 and web2) will be picked up by the load balancer as a target</span>
  <span class="s">web1</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="s">labels</span><span class="pi">:</span>
      <span class="s">foo</span><span class="pi">:</span> <span class="s">bar</span>
  <span class="s">web2</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="s">labels</span><span class="pi">:</span>
      <span class="s">foo</span><span class="pi">:</span> <span class="s">bar</span>
</code></pre>
</div>

<h6 id="example-rancher-composeyml-4">Example <code class="highlighter-rouge">rancher-compose.yml</code></h6>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb1</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">lb_config</span><span class="pi">:</span>
      <span class="s">port_rules</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">source_port</span><span class="pi">:</span> <span class="s">81</span>
        <span class="c1"># Target any service that has foo=bar as a label</span>
        <span class="s">selector</span><span class="pi">:</span> <span class="s">foo=bar</span>
        <span class="s">protocol</span><span class="pi">:</span> <span class="s">http</span>
    <span class="s">health_check</span><span class="pi">:</span>
      <span class="s">port</span><span class="pi">:</span> <span class="s">42</span>
      <span class="s">interval</span><span class="pi">:</span> <span class="s">2000</span>
      <span class="s">unhealthy_threshold</span><span class="pi">:</span> <span class="s">3</span>
      <span class="s">healthy_threshold</span><span class="pi">:</span> <span class="s">2</span>
      <span class="s">response_timeout</span><span class="pi">:</span> <span class="s">2000</span>
  <span class="c1"># web1 and web2 are targeted with the same source port but with the different hostname and path rules</span>
  <span class="s">web1</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">lb_config</span><span class="pi">:</span>
      <span class="s">port_rules</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">target_port</span><span class="pi">:</span> <span class="s">80</span>
        <span class="s">hostname</span><span class="pi">:</span> <span class="s">test.com</span>
  <span class="s">web2</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">lb_config</span><span class="pi">:</span>
      <span class="s">port_rules</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">target_port</span><span class="pi">:</span> <span class="s">80</span>
        <span class="s">hostname</span><span class="pi">:</span> <span class="s">example.com/test</span>     
</code></pre>
</div>

<h5 id="backend-name">Backend Name</h5>

<p>If you want to explicitly label your backend in your load balancer configuration, you would use the <code class="highlighter-rouge">backend_name</code>. This option can be useful if you want to configure custom config parameters for a particular backend.</p>

<h4 id="certificates">Certificates</h4>

<p>If you are using <code class="highlighter-rouge">https</code> or <code class="highlighter-rouge">tls</code> <a href="#protocol">protocol</a>, you can use certificates that are either <a href="/docs/rancher/v1.6/en/environments/certificates">added directly into Rancher</a> or from a directory mounted in the load balancer container.</p>

<h5 id="referencing-certificates-that-are-added-into-rancher">Referencing Certificates that are added into Rancher</h5>

<p>The certificates are referenced in the <code class="highlighter-rouge">lb_config</code> section of the load balancer container.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">lb_config</span><span class="pi">:</span>
      <span class="s">certs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">&lt;certName&gt;</span>
      <span class="s">default_cert</span><span class="pi">:</span> <span class="s">&lt;defaultCertName&gt;</span>
</code></pre>
</div>

<h5 id="loading-certificates-into-the-load-balancer-container">Loading Certificates into the Load Balancer container</h5>

<p><em>Only supported in Compose Files</em></p>

<p>Certificates can be mounted directly into a load balancer container as a volume. The load balancer container expects the certificates to be in a specific directory structure. If you are using LetsEncrypt client to generate your certificates, then your directory structure is already configured in the format that Rancher expects. If you are not using LetsEncrypt, then the director and names of the certificates will need to be structured in a specific way.</p>

<p>Rancher’s load balancer will poll the certificate directories for updates. Any addition/removal of the certificates will be synced via polling every 30 seconds.</p>

<p>All certificates will be located under a single base certificate directory. This directory name will be used in a label on the load balancer service to inform the load balancer where the certificates are.</p>

<p>In this base directory, each certificate that is generated for a specific domain is required to be placed in a sub-directory folder. The folder name should be the domain name for the certificate and each folder should contain the private key (i.e. <code class="highlighter-rouge">privkey.pem</code>) and certificate chain (<code class="highlighter-rouge">fullchain.pem</code>). For the default certificate, it can be placed in any subdirectory name, but the files in the folder must contain the same naming conventions as the certificates (i.e. <code class="highlighter-rouge">privkey.pem</code> and <code class="highlighter-rouge">fullchain.pem</code>).</p>

<div class="highlighter-rouge"><pre class="highlight"><code>-- certs
  |-- foo.com
  |   |-- privkey.pem
  |   |-- fullchain.pem
  |-- bar.com
  |   |-- privkey.pem
  |   |-- fullchain.pem
  |-- default_cert_dir_optional
  |   |-- privkey.pem
  |   |-- fullchain.pem
...
</code></pre>
</div>

<p>When launching a load balancer, you must specify the location of the certificates and the location of the default certificate by using labels. If these labels are on the load balancer, the load balancer will ignore any certificates that are in the <code class="highlighter-rouge">lb_config</code> key of the load balancer.</p>

<blockquote>
  <p><strong>Note:</strong> You cannot use the certificates added into Rancher in conjunction with mounting certificates into the container through a volume.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">labels</span><span class="pi">:</span>
  <span class="s">io.rancher.lb_service.cert_dir</span><span class="pi">:</span> <span class="s">&lt;CERTIFICATE_LOCATION&gt;</span>
  <span class="s">io.rancher.lb_service.default_cert_dir</span><span class="pi">:</span> <span class="s">&lt;DEFAULT_CERTIFICATE_LOCATION&gt;</span>
</code></pre>
</div>

<p>Certificates can be mounted into the load balancer container by using host bind mounts or using a named volume with our <a href="/docs/rancher/v1.6/en/rancher-services/storage-service/">storage drivers</a> as a volume drivers.</p>

<h6 id="example-docker-composeyml-3">Example <code class="highlighter-rouge">docker-compose.yml</code></h6>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">rancher/lb-service-haproxy:&lt;TAG_BASED_ON_RELEASE&gt;</span>
    <span class="s">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/location/on/hosts:/certs</span>
    <span class="s">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">8087:8087/tcp</span>
    <span class="s">labels</span><span class="pi">:</span>
      <span class="s">io.rancher.container.agent.role</span><span class="pi">:</span> <span class="s">environmentAdmin</span>
      <span class="s">io.rancher.container.create_agent</span><span class="pi">:</span> <span class="s1">'</span><span class="s">true'</span>
      <span class="s">io.rancher.lb_service.cert_dir</span><span class="pi">:</span> <span class="s">/certs</span>
      <span class="s">io.rancher.lb_service.default_cert_dir</span><span class="pi">:</span> <span class="s">/certs/default.com</span>
  <span class="s">myapp</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">nginx:latest</span>
    <span class="s">stdin_open</span><span class="pi">:</span> <span class="s">true</span>
    <span class="s">tty</span><span class="pi">:</span> <span class="s">true</span>
</code></pre>
</div>

<h6 id="example-rancher-composeyml-5">Example <code class="highlighter-rouge">rancher-compose.yml</code></h6>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">start_on_create</span><span class="pi">:</span> <span class="s">true</span>
    <span class="s">lb_config</span><span class="pi">:</span>
      <span class="s">certs</span><span class="pi">:</span> <span class="pi">[]</span>
      <span class="s">port_rules</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">priority</span><span class="pi">:</span> <span class="s">1</span>
        <span class="s">protocol</span><span class="pi">:</span> <span class="s">https</span>
        <span class="s">service</span><span class="pi">:</span> <span class="s">myapp</span>
        <span class="s">source_port</span><span class="pi">:</span> <span class="s">8087</span>
        <span class="s">target_port</span><span class="pi">:</span> <span class="s">80</span>
    <span class="s">health_check</span><span class="pi">:</span>
      <span class="s">healthy_threshold</span><span class="pi">:</span> <span class="s">2</span>
      <span class="s">response_timeout</span><span class="pi">:</span> <span class="s">2000</span>
      <span class="s">port</span><span class="pi">:</span> <span class="s">42</span>
      <span class="s">unhealthy_threshold</span><span class="pi">:</span> <span class="s">3</span>
      <span class="s">interval</span><span class="pi">:</span> <span class="s">2000</span>
      <span class="s">strategy</span><span class="pi">:</span> <span class="s">recreate</span>
  <span class="s">myapp</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">start_on_create</span><span class="pi">:</span> <span class="s">true</span>
</code></pre>
</div>

<h4 id="custom-configuration">Custom configuration</h4>

<p>For advanced users, you can specify custom configuration to the load balancer in the <code class="highlighter-rouge">rancher-compose.yml</code>. Please refer to the <a href="http://cbonte.github.io/haproxy-dconv/configuration-1.5.html">HAProxy documentation</a> for details on the available options you can add for the Rancher’s HAProxy load balancer.</p>

<h5 id="example-rancher-composeyml-6">Example <code class="highlighter-rouge">rancher-compose.yml</code></h5>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">lb_config</span><span class="pi">:</span>
      <span class="s">config</span><span class="pi">:</span> <span class="pi">|-</span>
        <span class="no">global</span>
            <span class="no">maxconn 4096</span>
            <span class="no">maxpipes 1024</span>

        <span class="no">defaults</span>
            <span class="no">log global</span>
            <span class="no">mode    tcp</span>
            <span class="no">option  tcplog</span>

        <span class="no">frontend 80</span>
            <span class="no">balance leastconn</span>

        <span class="no">frontend 90</span>
            <span class="no">balance roundrobin</span>

        <span class="no">backend mystack_foo</span>
            <span class="no">cookie my_cookie insert indirect nocache postonly</span>
            <span class="no">server $$IP &lt;server parameters&gt;</span>

        <span class="no">backend customUUID</span>
  <span class="s">health_check</span><span class="pi">:</span>
    <span class="s">port</span><span class="pi">:</span> <span class="s">42</span>
    <span class="s">interval</span><span class="pi">:</span> <span class="s">2000</span>
    <span class="s">unhealthy_threshold</span><span class="pi">:</span> <span class="s">3</span>
    <span class="s">healthy_threshold</span><span class="pi">:</span> <span class="s">2</span>
    <span class="s">response_timeout</span><span class="pi">:</span> <span class="s">2000</span>
</code></pre>
</div>

<h4 id="stickiness-policy">Stickiness Policy</h4>

<p>If you want to specify stickiness policy, you can update the policies in <code class="highlighter-rouge">rancher-compose.yml</code>.</p>

<h5 id="example-rancher-composeyml-7">Example <code class="highlighter-rouge">rancher-compose.yml</code></h5>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">lb_config</span><span class="pi">:</span>
      <span class="s">stickiness_policy</span><span class="pi">:</span>
        <span class="s">name</span><span class="pi">:</span> <span class="s">&lt;policyName&gt;</span>
        <span class="s">cookie</span><span class="pi">:</span> <span class="s">&lt;cookieInfo&gt;</span>
        <span class="s">domain</span><span class="pi">:</span> <span class="s">&lt;domainName&gt;</span>
        <span class="s">indirect</span><span class="pi">:</span> <span class="s">false</span>
        <span class="s">nocache</span><span class="pi">:</span> <span class="s">false</span>
        <span class="s">postonly</span><span class="pi">:</span> <span class="s">false</span>
        <span class="s">mode</span><span class="pi">:</span> <span class="s">&lt;mode&gt;</span>
  <span class="s">health_check</span><span class="pi">:</span>
    <span class="s">port</span><span class="pi">:</span> <span class="s">42</span>
    <span class="s">interval</span><span class="pi">:</span> <span class="s">2000</span>
    <span class="s">unhealthy_threshold</span><span class="pi">:</span> <span class="s">3</span>
    <span class="s">healthy_threshold</span><span class="pi">:</span> <span class="s">2</span>
    <span class="s">response_timeout</span><span class="pi">:</span> <span class="s">2000</span>
</code></pre>
</div>

<h3 id="rancher-compose-examples">Rancher Compose Examples</h3>

<h4 id="load-balancer-example-l7">Load Balancer Example (L7)</h4>

<h5 id="example-docker-composeyml-4">Example <code class="highlighter-rouge">docker-compose.yml</code></h5>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">web</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="s">lb</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">rancher/lb-service-haproxy</span>
  <span class="s">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">80</span>
  <span class="pi">-</span> <span class="s">82</span>
</code></pre>
</div>

<h5 id="example-rancher-composeyml-8">Example <code class="highlighter-rouge">rancher-compose.yml</code></h5>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">lb_config</span><span class="pi">:</span>
      <span class="s">port_rules</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">source_port</span><span class="pi">:</span> <span class="s">80</span>
        <span class="s">target_port</span><span class="pi">:</span> <span class="s">8080</span>
        <span class="s">service</span><span class="pi">:</span> <span class="s">web1</span>
        <span class="s">hostname</span><span class="pi">:</span> <span class="s">app.example.com</span>
        <span class="s">path</span><span class="pi">:</span> <span class="s">/foo</span>
      <span class="pi">-</span> <span class="s">source_port</span><span class="pi">:</span> <span class="s">82</span>
        <span class="s">target_port</span><span class="pi">:</span> <span class="s">8081</span>
        <span class="s">service</span><span class="pi">:</span> <span class="s">web2</span>
        <span class="s">hostname</span><span class="pi">:</span> <span class="s">app.example.com</span>
        <span class="s">path</span><span class="pi">:</span> <span class="s">/foo/bar</span>
  <span class="s">health_check</span><span class="pi">:</span>
    <span class="s">port</span><span class="pi">:</span> <span class="s">42</span>
    <span class="s">interval</span><span class="pi">:</span> <span class="s">2000</span>
    <span class="s">unhealthy_threshold</span><span class="pi">:</span> <span class="s">3</span>
    <span class="s">healthy_threshold</span><span class="pi">:</span> <span class="s">2</span>
    <span class="s">response_timeout</span><span class="pi">:</span> <span class="s">2000</span>
</code></pre>
</div>

<h4 id="internal-load-balancer-example">Internal Load Balancer Example</h4>

<p>To set up an internal load balancer, no ports are listed, but you can still set up port rules to direct traffic to the service.</p>

<h5 id="example-docker-composeyml-5">Example <code class="highlighter-rouge">docker-compose.yml</code></h5>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">rancher/lb-service-haproxy</span>
  <span class="s">web</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">nginx</span>
</code></pre>
</div>

<p><br /></p>

<h5 id="example--rancher-composeyml">Example  <code class="highlighter-rouge">rancher-compose.yml</code></h5>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">lb_config</span><span class="pi">:</span>
      <span class="s">port_rules</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">source_port</span><span class="pi">:</span> <span class="s">80</span>
        <span class="s">target_port</span><span class="pi">:</span> <span class="s">80</span>
        <span class="s">service</span><span class="pi">:</span> <span class="s">web</span>
    <span class="s">health_check</span><span class="pi">:</span>
      <span class="s">port</span><span class="pi">:</span> <span class="s">42</span>
      <span class="s">interval</span><span class="pi">:</span> <span class="s">2000</span>
      <span class="s">unhealthy_threshold</span><span class="pi">:</span> <span class="s">3</span>
      <span class="s">healthy_threshold</span><span class="pi">:</span> <span class="s">2</span>
      <span class="s">response_timeout</span><span class="pi">:</span> <span class="s">2000</span>
  <span class="s">web</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
</code></pre>
</div>

<h4 id="ssl-termination-example">SSL Termination Example</h4>

<p>The <a href="/docs/rancher/v1.6/en/environments/certificates/">certificates</a> must be added into Rancher and are defined in the <code class="highlighter-rouge">rancher-compose.yml</code>.</p>

<h5 id="example-docker-composeyml-6">Example <code class="highlighter-rouge">docker-compose.yml</code></h5>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">rancher/lb-service-haproxy</span>
    <span class="s">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">443</span>
  <span class="s">web</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">nginx</span>
</code></pre>
</div>

<p><br /></p>

<h5 id="example-rancher-composeyml-9">Example <code class="highlighter-rouge">rancher-compose.yml</code></h5>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="s">lb</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
    <span class="s">lb_config</span><span class="pi">:</span>
      <span class="s">certs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">&lt;certName&gt;</span>
      <span class="s">default_cert</span><span class="pi">:</span> <span class="s">&lt;defaultCertName&gt;</span>
      <span class="s">port_rules</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">source_port</span><span class="pi">:</span> <span class="s">443</span>
        <span class="s">target_port</span><span class="pi">:</span> <span class="s">443</span>
        <span class="s">service</span><span class="pi">:</span> <span class="s">web</span>
        <span class="s">protocol</span><span class="pi">:</span> <span class="s">https</span>
  <span class="s">web</span><span class="pi">:</span>
    <span class="s">scale</span><span class="pi">:</span> <span class="s">1</span>
</code></pre>
</div>


          <footer class="clearfix">
            <div class="copyright pull-left">Copyright &copy; 2014-2017 <a href="http://rancher.com">Rancher Labs</a>.  All Rights Reserved.</div>
            <a class="btn btn-primary pull-right" href="https://github.com/rancher/rancher.github.io/tree/master/rancher/v1.6/en/cattle/adding-load-balancers/index.md">Edit this page <i class="fa fa-pencil"></i></a>
          </footer>
        </div>
      </div>
    </div>

    <script src="/docs/vendor/jquery.js?t=2017-09-13 18:12:52 -0700"></script>
    <script src="/docs/js/jquery.slicknav.min.js?t=2017-09-13 18:12:52 -0700"></script>
    <script src="/docs/js/rancher-docs.js?t=2017-09-13 18:12:52 -0700"></script>

    <!-- Start of Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-56382716-3', 'auto');
        ga('send', 'pageview');
    </script>
    <!-- End of Google Analytics -->

    <!-- Start of Async HubSpot Analytics Code -->
    <script type="text/javascript">
    (function(d,s,i,r) {
    if (d.getElementById(i)){return;}
    var n=d.createElement(s),e=d.getElementsByTagName(s)[0];
    n.id=i;n.src='//js.hs-analytics.net/analytics/'+(Math.ceil(new Date()/r)*r)+'/468859.js';
    e.parentNode.insertBefore(n, e);
    })(document,"script","hs-analytics",300000);
    </script>
    <!-- End of Async HubSpot Analytics Code -->
  </body>
</html>

